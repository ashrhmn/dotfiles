#!/bin/bash

# ai-generated commit message script
# This script collects staged changes and recent logs, then feeds them to ai

# Parse arguments
custom_date=""
commit_message=""
model_name="haiku"
while [[ $# -gt 0 ]]; do
    case $1 in
        --date=*)
            custom_date="${1#*=}"
            shift
            ;;
        --date)
            custom_date="$2"
            shift 2
            ;;
        -m|--message)
            commit_message="$2"
            shift 2
            ;;
        --model)
            model_name="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: gemmit [--date=YYYY-MM-DDTHH:MM:SS] [-m|--message \"commit message\"] [--model MODEL]"
            exit 1
            ;;
    esac
done

# Check if there are staged changes
if git diff --staged --quiet; then
    echo "Error: No staged changes to commit. Use 'git add' to stage changes first."
    exit 1
fi

# Set environment variables for custom date if provided
if [[ -n "$custom_date" ]]; then
    export GIT_AUTHOR_DATE="$custom_date"
    export GIT_COMMITTER_DATE="$custom_date"
fi

# If message is provided, commit directly without AI generation
if [[ -n "$commit_message" ]]; then
    git commit -m "$commit_message"
    exit 0
fi

# Create temporary file for diff in current working directory
diff_file="./gemmit_diff_$(date +%s)_$$"

# Write staged changes to temporary file
git diff --staged -- . \
  ':(exclude)pnpm-lock.yaml' \
  ':(exclude)package-lock.json' \
  ':(exclude)yarn.lock' \
  ':(exclude)bun.lockb' \
  ':(exclude)poetry.lock' \
  ':(exclude)Pipfile.lock' \
  ':(exclude)go.sum' \
  ':(exclude)Cargo.lock' \
  ':(exclude)composer.lock' \
  ':(exclude)dist/' \
  ':(exclude)build/' \
  ':(exclude)node_modules/' \
  ':(exclude)target/' \
  ':(exclude)__pycache__/' \
  ':(exclude).venv/' > "$diff_file"

# Create temporary file for commit message
temp_file=$(mktemp)

# Prepare the prompt with file path reference
prompt="CRITICAL: You are a git commit message generator in RAW OUTPUT MODE.
Your ENTIRE response will be piped DIRECTLY into 'git commit -F'.

Read the diff from: $diff_file

RULES:
1. Character #1 of your response MUST be one of: f, r, d, s, t, c, p (the start of a commit type)
2. NO preamble, analysis, description, or meta-commentary whatsoever
3. Format: type(scope): subject\\n\\nbody with details

FORBIDDEN (will break git):
- \"The changes/diff shows...\"
- \"Based on the diff...\"
- \"I see that...\"
- Any analysis before the commit message
- Backticks, quotes, markdown formatting

VALID OUTPUT:
fix(auth): resolve login timeout issue

Increase session timeout from 5m to 30m
- Prevents premature logouts during long forms

INVALID OUTPUT:
The diff shows authentication changes in auth.ts and config.ts:
- Modified timeout value
- Updated session handling

fix(auth): resolve login timeout issue

YOUR RESPONSE STARTS NOW:"

# Call ai with the prepared prompt and save to temp file
claude --model "$model_name" -p "$prompt" > "$temp_file"

# Open git commit editor with the generated message
git commit -e -F "$temp_file"

# Clean up
rm "$temp_file" "$diff_file"
