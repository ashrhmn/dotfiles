#!/bin/bash

VERSION="1.0.0"

usage() {
    cat << EOF
Usage: rename-by-date [OPTIONS] <directory>

Rename images and videos based on their timestamp metadata (EXIF date taken).
Only renames files that have valid date metadata.

Options:
    --dry-run, -n       Show what would be renamed without actually renaming
    --format <fmt>      Timestamp format (default: %Y%m%d_%H%M%S)
    --help, -h          Show this help message
    --version, -v       Show version information

Supported formats:
    Images: .jpg, .jpeg, .png, .gif, .bmp, .tiff, .webp
    Videos: .mp4, .mov, .avi, .mkv, .m4v, .3gp

Examples:
    rename-by-date --dry-run ~/Pictures
    rename-by-date --format "%Y-%m-%d_%H%M%S" ~/Downloads
    rename-by-date ~/Videos

Note:
    Files without date metadata will be skipped.
    Files starting with ._ (macOS resource forks) will be skipped.
    Existing files with the same name will be avoided with numeric suffixes.
EOF
}

show_version() {
    echo "rename-by-date version $VERSION"
}

DRY_RUN=0
TIMESTAMP_FORMAT="%Y%m%d_%H%M%S"
TARGET_DIR=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run|-n)
            DRY_RUN=1
            shift
            ;;
        --format)
            TIMESTAMP_FORMAT="$2"
            shift 2
            ;;
        --help|-h)
            usage
            exit 0
            ;;
        --version|-v)
            show_version
            exit 0
            ;;
        -*)
            echo "Error: Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            if [[ -z "$TARGET_DIR" ]]; then
                TARGET_DIR="$1"
            else
                echo "Error: Multiple directories specified"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

if [[ -z "$TARGET_DIR" ]]; then
    echo "Error: No directory specified"
    usage
    exit 1
fi

if [[ ! -d "$TARGET_DIR" ]]; then
    echo "Error: Directory not found: $TARGET_DIR"
    exit 1
fi

if ! command -v exiftool &> /dev/null; then
    echo "Error: exiftool is required but not installed"
    exit 1
fi

extract_date() {
    exiftool -DateTimeOriginal -CreateDate -MediaCreateDate -d "%Y:%m:%d %H:%M:%S" "$1" 2>/dev/null | 
               grep -E "(Date/Time Original|Create Date|Media Create Date)" | 
               head -1 | 
               awk -F': ' '{print $2}' | 
               grep -v "^0000:00:00" | head -1 || true
}

format_date() {
    if [[ -z "$1" ]]; then
        return 1
    fi
    
    date_fixed=$(echo "$1" | sed 's/:/-/; s/:/-/')
    date -d "$date_fixed" +"$2" 2>/dev/null || return 1
}

process_file() {
    file_path="$1"
    dir_name=$(dirname "$file_path")
    base_name=$(basename "$file_path")
    extension="${base_name##*.}"
    
    if [[ "$base_name" == ._* ]] || [[ "$base_name" == .* ]]; then
        return 0
    fi
    
    date_str=$(extract_date "$file_path")
    
    if [[ -z "$date_str" ]]; then
        echo "SKIP (no date): $base_name"
        return 0
    fi
    
    formatted_date=$(format_date "$date_str" "$TIMESTAMP_FORMAT")
    
    if [[ -z "$formatted_date" ]]; then
        echo "SKIP (invalid date): $base_name"
        return 0
    fi
    
    new_name="${formatted_date}.${extension}"
    new_path="${dir_name}/${new_name}"
    
    if [[ "$file_path" == "$new_path" ]]; then
        echo "SKIP (already named): $base_name"
        return 0
    fi
    
    if [[ -e "$new_path" ]]; then
        counter=1
        while [[ -e "${dir_name}/${formatted_date}_${counter}.${extension}" ]]; do
            ((counter++))
        done
        new_name="${formatted_date}_${counter}.${extension}"
        new_path="${dir_name}/${new_name}"
    fi
    
    if [[ $DRY_RUN -eq 1 ]]; then
        echo "WOULD RENAME: $base_name -> $new_name"
    else
        mv "$file_path" "$new_path" && echo "RENAMED: $base_name -> $new_name" || echo "ERROR renaming: $base_name"
    fi
}

main() {
    if [[ $DRY_RUN -eq 1 ]]; then
        echo "DRY RUN MODE - No files will be renamed"
        echo "=========================================="
    fi
    
    echo "Processing files in: $TARGET_DIR"
    echo ""
    
    file_count=0
    while IFS= read -r -d '' file; do
        ((file_count++))
        process_file "$file"
    done < <(find "$TARGET_DIR" -type f ! -name "._*" \( \
        -iname "*.jpg" -o -iname "*.jpeg" -o \
        -iname "*.png" -o -iname "*.gif" -o \
        -iname "*.bmp" -o -iname "*.tiff" -o -iname "*.webp" -o \
        -iname "*.mp4" -o -iname "*.mov" -o -iname "*.avi" -o \
        -iname "*.mkv" -o -iname "*.m4v" -o -iname "*.3gp" \
    \) -print0)
    
    echo ""
    echo "=========================================="
    echo "Media files processed: $file_count"
    
    if [[ $DRY_RUN -eq 1 ]]; then
        echo ""
        echo "This was a dry run. Use without --dry-run to actually rename files."
    fi
}

main
